---
import CVLayout from '../layouts/CVLayout.astro';
import ExperienceCard from '../components/ExperienceCard.astro';
import CVSection from '../components/cv/CVSection.astro';
import CVGrid from '../components/cv/CVGrid.astro';
import CVCard from '../components/cv/CVCard.astro';
import { getEntry } from 'astro:content';
import { siteConfig } from '../config/site.ts';
import { parseCVContent } from '../utils/cvParser.ts';

// Get CV content from Markdown
const cvEntry = await getEntry('cv', 'cv');
if (!cvEntry) {
  throw new Error('CV content not found');
}
const { title, description } = siteConfig;

// Parse structured data from Markdown content
const cvContent = parseCVContent(cvEntry.body, cvEntry.data);
---

<CVLayout title={title} description={description}>
  <div class="pl-4 pr-4 sm:pl-6 sm:pr-6 lg:pl-page lg:pr-8 pt-6 sm:pt-8 pb-12 sm:pb-16">
    <header class="mb-section" role="banner">
      <h1 class="text-hero text-cv-accent font-semibold font-lora" id="main-title">{cvContent.name}</h1>
    </header>

    <CVGrid>
      <CVCard title="Education" id="education-section">
        {cvContent.education.map((edu) => (
          <div>
            <span class="inline-flex items-center gap-1.5 px-3 py-1 text-sm bg-cv-accent text-white rounded-sm border border-cv-accent shadow-sm hover:bg-cv-accent/80 transition-colors mb-2 font-ibm-plex-mono">
              <svg width="16" height="16" viewBox="0 0 32 32" fill="white" class="flex-shrink-0">
                <path d="M26 4h-4V2h-2v2h-8V2h-2v2H6a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM6 6h4v2h2V6h8v2h2V6h4v4H6zm0 6h20v14H6z"/>
              </svg>
              {edu.period}
            </span>
            <h4 class="text-sm text-cv-content mb-1 font-semibold font-lora">
              {edu.title}
            </h4>
            <p class="text-body text-cv-muted">{edu.institution}</p>
          </div>
        ))}
      </CVCard>

      <CVCard title="Contact Info" id="contact-section">
        <div class="space-y-3">
          <p class="text-body text-cv-muted">Email: <a href={`mailto:${cvContent.contact.email}`} class="text-cv-accent hover:underline">{cvContent.contact.email}</a></p>
          <p class="text-body text-cv-muted">Portfolio: <a href={cvContent.contact.portfolio.url} class="text-cv-accent hover:underline" target="_blank" rel="noopener noreferrer">{cvContent.contact.portfolio.text}</a></p>
          <p class="text-body text-cv-muted">LinkedIn: {cvContent.contact.linkedin}</p>
          <p class="text-body text-cv-muted">{cvContent.contact.location}</p>
        </div>
      </CVCard>

      <CVCard title="Interests" id="interests-section">
        <div class="grid grid-cols-1 gap-y-2">
          {cvContent.interests.map((interest) => (
            <p class="text-body text-cv-muted flex items-center gap-2">
              <span class="w-2 h-2 bg-cv-accent rounded-full"></span>
              {interest}
            </p>
          ))}
        </div>
      </CVCard>
    </CVGrid>

    <CVSection title="Experience" subtitle="10+ years" id="experience-section">
      {cvContent.experience.map((exp) => (
        <ExperienceCard
          company={exp.company}
          companyUrl={exp.companyUrl}
          role={exp.role}
          period={exp.period}
          current={exp.current}
          logo={exp.logo}
        >
          {exp.achievements.map((achievement) => (
            <li class="text-body text-cv-content flex">
              <span class="mr-3">•</span>
              <span>{achievement}</span>
            </li>
          ))}
        </ExperienceCard>
      ))}
    </CVSection>

    <CVSection title="Skills" subtitle="Professional expertise" id="skills-section">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-section">
        {cvContent.skills.map((skill) => (
          <ExperienceCard
            company={skill.title}
            role={skill.subtitle}
            period={skill.level}
            current={skill.current}
          >
            {skill.items.map((item) => (
              <li class="text-body text-cv-content flex">
                <span class="mr-3">•</span>
                <span>{item}</span>
              </li>
            ))}
          </ExperienceCard>
        ))}
      </div>
    </CVSection>
  </div>   
</CVLayout>
